<div class="story-writing-container">
  <!-- Main Story Writing Area -->
  <div class="story-writing-main" [class.drawer-open]="isDrawerOpen">
    <div class="story-header">
      <h1>Story Writing</h1>
      <div class="header-actions">
        <button class="add-story-btn" (click)="toggleCreateForm()">
          <mat-icon>add</mat-icon>
          <span>Add Story</span>
        </button>
        <button class="drawer-toggle" (click)="toggleDrawer()">
          <mat-icon>{{ isDrawerOpen ? 'chevron_right' : 'help_outline' }}</mat-icon>
          <span>{{ isDrawerOpen ? 'Hide Helpers' : 'Show Helpers' }}</span>
        </button>
      </div>
    </div>

    <!-- Collapsible Create Story Form -->
    <div class="create-story-section" [class.expanded]="showCreateForm">
      <div class="create-story-card">
        <div class="form-header">
          <h3>Create New Story</h3>
          <button class="close-form-btn" (click)="toggleCreateForm()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <form #storyForm="ngForm" (ngSubmit)="createStoryData(storyForm)" class="story-form">
          <div class="form-group">
            <label>Story Name</label>
            <input type="text" name="name" [(ngModel)]="createStory.title" required placeholder="Enter story title..." />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Structure</label>
              <select name="structure" [(ngModel)]="createStory.structure" required>
                <option *ngFor="let s of storyStructures" [value]="s">{{ s }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Timeline</label>
              <select name="timeline" [(ngModel)]="createStory.timeline" required>
                <option *ngFor="let t of timelines" [value]="t">{{ t }}</option>
              </select>
            </div>
          </div>
          
          <button type="submit" [disabled]="storyForm.invalid" class="create-btn">
            <mat-icon>add</mat-icon>
            Create Story
          </button>
        </form>
      </div>
    </div>
    
    <!-- Story Tabs and Writing Area -->
    <div class="stories-section" *ngIf="(stories?.length ?? 0) > 0">
      <div class="story-tabs">
        <button 
          *ngFor="let tab of stories; trackBy: trackByStoryTitle" 
          (click)="selectedStory(tab)"
          [class.active]="activeStory?.title === tab?.title"
          class="story-tab">
          {{ tab?.title }}
        </button>
      </div>

      <div class="story-editor" *ngIf="activeStory">
        <div class="editor-header">
          <h3>{{ activeStory.name }}</h3>
          <div class="story-info">
            <span class="info-item">
              <strong>Structure:</strong> {{ activeStory.structure }}
            </span>
            <span class="info-item">
              <strong>Timeline:</strong> {{ activeStory.timeline }}
            </span>
          </div>
          <div class="editor-actions">
            <button (click)="saveDraft()" class="save-btn">
              <mat-icon>save</mat-icon>
              Save Draft
            </button>
            <button (click)="submitDraft()" class="submit-btn">
              <mat-icon>publish</mat-icon>
              Submit
            </button>
          </div>
        </div>
        
        <div class="writing-area">
          <div class="document-container">
            <div class="document-page">
                <div
                class="story-document"
                contenteditable="true"
                (input)="onDocumentChange($event)"
                (mouseup)="onTextSelection($event)"
                (keyup)="onTextSelection($event)"
                #documentEditor>
                </div>

              
              <!-- AI Assistant Popup -->
              <div 
                class="ai-assistant-popup" 
                *ngIf="showAiAssistant"
                [style.top.px]="aiAssistantPosition.top"
                [style.left.px]="aiAssistantPosition.left">
                <div class="ai-assistant-content">
                  <button class="ai-help-btn" (click)="openAiHelp()">
                    <mat-icon>psychology</mat-icon>
                    AI Assistant
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Empty State -->
    <div class="empty-stories-state" *ngIf="(stories?.length ?? 0) === 0">
      <div class="empty-content">
        <h3>No stories for project</h3>
        <p>Create new story to begin your writing journey</p>
        <button class="create-first-story-btn" (click)="toggleCreateForm()">
          <mat-icon>add</mat-icon>
          Create Your First Story
        </button>
      </div>
    </div>
  </div>

  <!-- Collapsible Story Helpers Drawer -->
  <div class="story-helpers-drawer" [class.open]="isDrawerOpen">
    <div class="drawer-header">
      <h3>Story Helpers</h3>
      <button class="close-drawer" (click)="toggleDrawer()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="drawer-tabs">
      <button 
        *ngFor="let tab of helperTabs" 
        (click)="activeHelperTab = tab.id"
        [class.active]="activeHelperTab === tab.id"
        class="helper-tab">
        <mat-icon>{{ tab.icon }}</mat-icon>
        {{ tab.name }}
      </button>
    </div>

    <div class="drawer-content">
      <!-- Demographics Tab -->
      <div class="tab-content" *ngIf="activeHelperTab === 'demographics'">
        <div class="demographics-content">
          <!-- Demographics Type Selector -->
          <div class="demographics-selector">
            <button 
              (click)="selectedDemographicsType = 'target'"
              [class.active]="selectedDemographicsType === 'target'"
              class="demographics-type-btn">
              Target Demographics
            </button>
            <button 
              (click)="selectedDemographicsType = 'project'"
              [class.active]="selectedDemographicsType === 'project'"
              class="demographics-type-btn">
              Project Demographics
            </button>
          </div>

          <!-- Target Demographics View -->
          <div *ngIf="selectedDemographicsType === 'target'" class="demographics-view">
            <div *ngIf="!activeStory?.target_demographics && !activeStory?.selected_tags" class="no-demographics">
              <p>Add tags to see target demographics</p>
              <button (click)="toggleTagsPopup()" class="add-tags-btn">
                <mat-icon>add</mat-icon>
                Add Tags
              </button>
            </div>
            
            <div *ngIf="activeStory?.target_demographics || activeStory?.selected_tags" class="demographics-display">
              <!-- Target Demographics Heatmap -->
              <div class="demographics-heatmap" *ngIf="activeStory?.target_demographics">
                <h4>Target Demographics Heatmap</h4>
                <div class="heatmap-container">
                  <div class="heatmap-section">
                    <h5>Age Groups</h5>
                    <div class="heatmap-grid">
                      <div 
                        *ngFor="let item of getTargetAgeData()" 
                        class="heatmap-cell"
                        [class.high-positive]="item.value >= 0.15"
                        [class.medium-positive]="item.value >= 0.05 && item.value < 0.15"
                        [class.high-negative]="item.value <= -0.15"
                        [class.medium-negative]="item.value <= -0.05 && item.value > -0.15">
                        <div class="cell-label">{{ item.label }}</div>
                        <div 
                          class="cell-value"
                          [class.positive]="item.value >= 0"
                          [class.negative]="item.value < 0"
                          [class.neutral]="item.value === 0">
                          {{ (item.value * 100).toFixed(0) }}%
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="heatmap-section">
                    <h5>Gender</h5>
                    <div class="heatmap-grid">
                      <div 
                        *ngFor="let item of getTargetGenderData()" 
                        class="heatmap-cell"
                        [class.high-positive]="item.value >= 0.15"
                        [class.medium-positive]="item.value >= 0.05 && item.value < 0.15"
                        [class.high-negative]="item.value <= -0.15"
                        [class.medium-negative]="item.value <= -0.05 && item.value > -0.15">
                        <div class="cell-label">{{ item.label }}</div>
                        <div 
                          class="cell-value"
                          [class.positive]="item.value >= 0"
                          [class.negative]="item.value < 0"
                          [class.neutral]="item.value === 0">
                          {{ (item.value * 100).toFixed(0) }}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Target Selected Tags -->
              <div class="selected-tags-display" *ngIf="activeStory?.selected_tags">
                <h4>Selected Tags ({{ activeStory.selected_tags.length }})</h4>
                <div class="tags-list">
                  <div *ngFor="let tag of activeStory.selected_tags" class="tag-item-display">
                    <span class="tag-name">{{ tag.name }}</span>
                    <span class="tag-type" *ngIf="tag.type">{{ (tag.type ?? '') | tagType }}</span>
                  </div>
                </div>
                <button (click)="toggleTagsPopup()" class="add-tags-btn">
                  <mat-icon>edit</mat-icon>
                  Edit Tags
                </button>
              </div>
            </div>
          </div>

          <!-- Project Demographics View -->
          <div *ngIf="selectedDemographicsType === 'project'" class="demographics-view">
            <div *ngIf="!activeStory?.projected_demographics" class="no-demographics">
              <p>Submit Story to see the projected demographics.</p>
            </div>
            
            <div *ngIf="activeStory?.projected_demographics" class="demographics-display">
              <!-- Project Demographics Heatmap -->
              <div class="demographics-heatmap">
                <h4>Project Demographics Heatmap</h4>
                <div class="heatmap-container">
                  <div class="heatmap-section">
                    <h5>Age Groups</h5>
                    <div class="heatmap-grid">
                      <div 
                        *ngFor="let item of getProjectAgeData()" 
                        class="heatmap-cell"
                        [class.high-positive]="item.value >= 0.15"
                        [class.medium-positive]="item.value >= 0.05 && item.value < 0.15"
                        [class.high-negative]="item.value <= -0.15"
                        [class.medium-negative]="item.value <= -0.05 && item.value > -0.15">
                        <div class="cell-label">{{ item.label }}</div>
                        <div 
                          class="cell-value"
                          [class.positive]="item.value >= 0"
                          [class.negative]="item.value < 0"
                          [class.neutral]="item.value === 0">
                          {{ (item.value * 100).toFixed(0) }}%
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="heatmap-section">
                    <h5>Gender</h5>
                    <div class="heatmap-grid">
                      <div 
                        *ngFor="let item of getProjectGenderData()" 
                        class="heatmap-cell"
                        [class.high-positive]="item.value >= 0.15"
                        [class.medium-positive]="item.value >= 0.05 && item.value < 0.15"
                        [class.high-negative]="item.value <= -0.15"
                        [class.medium-negative]="item.value <= -0.05 && item.value > -0.15">
                        <div class="cell-label">{{ item.label }}</div>
                        <div 
                          class="cell-value"
                          [class.positive]="item.value >= 0"
                          [class.negative]="item.value < 0"
                          [class.neutral]="item.value === 0">
                          {{ (item.value * 100).toFixed(0) }}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Help Tab -->
      <div class="tab-content" *ngIf="activeHelperTab === 'ai'">
        <div class="ai-help-content">
          <form class="ai-help-form" (ngSubmit)="submitAiHelp()">
            <div class="form-group">
              <label>Context (Selected Text)</label>
              <textarea 
                [(ngModel)]="aiHelpContext" 
                name="context"
                readonly 
                class="context-textarea"
                placeholder="Select text in the document to provide context..."></textarea>
            </div>
            
            <div class="form-group">
              <label>Tags</label>
              <div class="tags-selection">
                <div 
                  *ngFor="let tag of (activeStory?.selected_tags || [])" 
                  class="tag-checkbox-item">
                  <input 
                    type="checkbox" 
                    [id]="'tag-' + tag.name"
                    [(ngModel)]="tag.selected"
                    name="tag-{{tag.name}}" />
                  <label [for]="'tag-' + tag.name">{{ tag.name }}</label>
                </div>
                <div *ngIf="!activeStory?.selected_tags || activeStory.selected_tags.length === 0" class="no-tags">
                  No tags available. Add tags in Demographics tab first.
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Help Instructions</label>
              <textarea 
                [(ngModel)]="aiHelpInstructions" 
                name="instructions"
                placeholder="What kind of help do you need? (e.g., improve dialogue, add description, fix pacing...)"
                rows="3"></textarea>
            </div>
            
            <button 
              type="submit" 
              class="help-me-btn"
              [disabled]="!aiHelpContext || !aiHelpInstructions">
              <mat-icon>auto_fix_high</mat-icon>
              Help me!
            </button>
          </form>
          
          <div class="ai-response" *ngIf="aiHelpResponse">
            <h4>AI Suggestions</h4>
            <div class="response-content" [innerHTML]="aiHelpResponse"></div>
          </div>
        </div>
      </div>

      <!-- Project Information Tab -->
      <div class="tab-content" *ngIf="activeHelperTab === 'project'">
        <div class="project-info">
          <div class="info-section">
            <h4>Story Idea</h4>
            <p>{{ projectData.idea }}</p>
          </div>

          <div class="info-section" *ngIf="projectData.genres?.length > 0">
            <h4>Genres</h4>
            <div class="genre-tags">
              <span *ngFor="let genre of projectData.genres" class="genre-tag">{{ genre }}</span>
            </div>
          </div>

          <div class="info-section" *ngIf="projectData.story_types?.length > 0">
            <h4>Story Types</h4>
            <div class="type-tags">
              <span *ngFor="let type of projectData.story_types" class="type-tag">{{ type }}</span>
            </div>
          </div>

          <div class="info-section" *ngIf="projectData.target_demographics">
            <h4>Target Demographics</h4>
            <div class="demographics-info">
              <div *ngIf="projectData.target_demographics?.age?.length > 0">
                <strong>Age:</strong>
                <span *ngFor="let age of projectData.target_demographics.age; let last = last">
                  {{ age }}<span *ngIf="!last">, </span>
                </span>
              </div>
              <div *ngIf="projectData.target_demographics?.gender">
                <strong>Gender:</strong>
                Male: {{ projectData.target_demographics.gender.male }}%, 
                Female: {{ projectData.target_demographics.gender.female }}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tags Popup -->
  <div class="tags-popup" [class.show]="showTagsPopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Add Tags</h3>
        <button class="close-popup" (click)="toggleTagsPopup()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="popup-body">
        <!-- Top Row: Search Bar -->
        <div class="popup-row search-row">
          <div class="search-input-group">
            <input 
              type="search" 
              [(ngModel)]="tagSearchText" 
              (keyup.enter)="searchTags()" 
              placeholder="Search for tags..."
              class="tag-search-input" />
            <button (click)="searchTags()" class="search-btn">
              <mat-icon>search</mat-icon>
            </button>
          </div>
        </div>

        <!-- Second Row: Heatmap + Selected Tags + Save Button -->
        <div class="popup-row heatmap-row" *ngIf="selectedTags.length > 0">
          <!-- First Sub-row: Heatmap -->
          <div class="aggregated-heatmap">
            <h4>Combined Demographics Heatmap ({{ selectedTags.length }} tags)</h4>
            <div class="heatmap-container">
              <div class="heatmap-section">
                <h5>Age Groups</h5>
                <div class="heatmap-grid">
                  <div 
                    *ngFor="let item of getAggregatedAgeData()" 
                    class="heatmap-cell"
                    [class.high-positive]="item.value >= 0.15"
                    [class.medium-positive]="item.value >= 0.05 && item.value < 0.15"
                    [class.high-negative]="item.value <= -0.15"
                    [class.medium-negative]="item.value <= -0.05 && item.value > -0.15">
                    <div class="cell-label">{{ item.label }}</div>
                    <div 
                      class="cell-value"
                      [class.positive]="item.value >= 0"
                      [class.negative]="item.value < 0"
                      [class.neutral]="item.value === 0">
                      {{ (item.value * 100).toFixed(0) }}%
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="heatmap-section">
                <h5>Gender</h5>
                <div class="heatmap-grid">
                  <div 
                    *ngFor="let item of getAggregatedGenderData()" 
                    class="heatmap-cell"
                    [class.high-positive]="item.value >= 0.15"
                    [class.medium-positive]="item.value >= 0.05 && item.value < 0.15"
                    [class.high-negative]="item.value <= -0.15"
                    [class.medium-negative]="item.value <= -0.05 && item.value > -0.15">
                    <div class="cell-label">{{ item.label }}</div>
                    <div 
                      class="cell-value"
                      [class.positive]="item.value >= 0"
                      [class.negative]="item.value < 0"
                      [class.neutral]="item.value === 0">
                      {{ (item.value * 100).toFixed(0) }}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Second Sub-row: Selected Tags + Save Button -->
          <div class="tags-and-save-row">
            <div class="selected-tags-section">
              <h4>Selected Tags ({{ selectedTags.length }}/15)</h4>
              <div class="selected-tags">
                <div 
                  *ngFor="let tag of selectedTags; trackBy: trackByTagName" 
                  class="selected-tag">
                  <span>{{ tag?.name }}</span>
                  <button (click)="removeSelectedTag(tag)" class="remove-tag">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
              
              <button 
                (click)="saveDemographics()" 
                class="save-demographics-btn"
                [disabled]="selectedTags.length === 0">
                Save as Target Demographics
              </button>
            </div>
          </div>
        </div>
        
        <!-- Third Row: Individual Tag Demographics -->
        <div class="popup-row individual-demographics-row" *ngIf="currentTagDemographics">
          <div class="individual-demographics">
            <h4>{{ currentTagDemographics.tagName }} Demographics</h4>
            <div class="demographics-charts">
              <div class="chart-section">
                <h5>Age Distribution</h5>
                <div class="chart-bars">
                  <div class="bar-item" *ngFor="let item of getAgeChartData()">
                    <div class="bar-label">{{ item.label }}</div>
                    <div class="bar-container">
                      <div 
                        class="bar-fill"
                        [class.positive]="item.value >= 0"
                        [class.negative]="item.value < 0"
                        [style.width.%]="Math.abs(item.value) * 100">
                      </div>
                    </div>
                    <div 
                      class="bar-value"
                      [class.positive]="item.value >= 0"
                      [class.negative]="item.value < 0">
                      {{ (item.value * 100).toFixed(0) }}%
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="chart-section">
                <h5>Gender Distribution</h5>
                <div class="chart-bars">
                  <div class="bar-item" *ngFor="let item of getGenderChartData()">
                    <div class="bar-label">{{ item.label }}</div>
                    <div class="bar-container">
                      <div 
                        class="bar-fill"
                        [class.positive]="item.value >= 0"
                        [class.negative]="item.value < 0"
                        [style.width.%]="Math.abs(item.value) * 100">
                      </div>
                    </div>
                    <div 
                      class="bar-value"
                      [class.positive]="item.value >= 0"
                      [class.negative]="item.value < 0">
                      {{ (item.value * 100).toFixed(0) }}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Fourth Row: Tags List -->
        <div class="popup-row tags-list-row" *ngIf="(searchedTags?.length ?? 0) > 0">
          <h4>Suggested Tags</h4>
          <div class="tags-grid">
            <div 
              *ngFor="let tag of searchedTags; trackBy: trackByTagName" 
              (click)="selectTag(tag)"
              class="tag-item"
              [class.selected]="isTagSelected(tag)"
              [class.disabled]="!isTagSelected(tag) && selectedTags.length >= 15">
              <div class="tag-name">{{ tag?.name }}</div>
              <div class="tag-type" *ngIf="tag?.type">{{ tag.type }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
