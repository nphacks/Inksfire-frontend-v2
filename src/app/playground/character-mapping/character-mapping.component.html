<div class="character-mapping-container">
  <div class="character-mapping-header">
    <h1>Character Mapping</h1>
    <div class="story-selector">
      <label>Select Story:</label>
      <select [(ngModel)]="selectedStoryIndex" (change)="onStoryChange()">
        <option *ngFor="let story of stories; let i = index" [value]="i">
          {{ story.title }}
        </option>
      </select>
    </div>
  </div>

  <div class="character-mapping-content" *ngIf="selectedStory">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button 
        (click)="activeTab = 'characters'"
        [class.active]="activeTab === 'characters'"
        class="tab-btn">
        <mat-icon>people</mat-icon>
        Characters
      </button>
      <button 
        (click)="activeTab = 'map'"
        [class.active]="activeTab === 'map'"
        class="tab-btn">
        <mat-icon>account_tree</mat-icon>
        Map
      </button>
    </div>

    <!-- Characters Tab -->
    <div class="tab-content" *ngIf="activeTab === 'characters'">
      <div class="characters-list">
        <div class="character-card" *ngFor="let character of characterList; let i = index">
          <div class="character-header">
            <h3>{{ character.name }}</h3>
            <button class="actor-options-btn" (click)="openActorOptions(character)">
              <mat-icon>person_search</mat-icon>
              Actor Options
            </button>
          </div>
          
          <div class="character-description">
            <p>{{ character.description }}</p>
          </div>
          
          <div class="character-notes">
            <label>Notes:</label>
            <textarea 
              [(ngModel)]="character.notes" 
              (input)="saveCharacterNotes(character)"
              placeholder="Add your notes about this character..."
              rows="3"></textarea>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="characterList.length === 0">
          <div class="empty-icon">üë•</div>
          <h3>No characters found</h3>
          <p>Characters will appear here once they are created for this story</p>
        </div>
      </div>
    </div>

    <!-- Map Tab -->
    <div class="tab-content" *ngIf="activeTab === 'map'">
      <div class="map-content">
        <div class="map-controls" *ngIf="characterMap.length > 0">
          <div class="history-selector">
            <label>View History:</label>
            <select [(ngModel)]="selectedHistoryType" (change)="onHistoryTypeChange()">
              <option value="type">Type</option>
              <option value="step">Step</option>
              <option value="notes">Notes</option>
            </select>
          </div>
        </div>

        <div class="character-tree-map" *ngIf="characterMap.length > 0">
          <div class="tree-container">
            <div class="character-nodes">
              <div 
                *ngFor="let character of getUniqueCharacters(); let i = index" 
                class="character-node"
                [style.left.px]="getCharacterPosition(character, i).x"
                [style.top.px]="getCharacterPosition(character, i).y"
                (click)="selectCharacterNode(character)">
                <div class="node-content">
                  <div class="character-name">{{ character }}</div>
                  <div class="connection-count">{{ getConnectionCount(character) }} connections</div>
                </div>
              </div>
            </div>
            
            <svg class="connection-lines" width="100%" height="100%">
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="var(--color3)" />
                </marker>
              </defs>
              <line 
                *ngFor="let relationship of characterMap; let i = index"
                [attr.x1]="getLineCoordinates(relationship).x1"
                [attr.y1]="getLineCoordinates(relationship).y1"
                [attr.x2]="getLineCoordinates(relationship).x2"
                [attr.y2]="getLineCoordinates(relationship).y2"
                [attr.stroke]="getRelationshipColor(relationship)"
                stroke-width="2"
                marker-end="url(#arrowhead)"
                class="relationship-line"
                (click)="selectRelationship(relationship)">
              </line>
            </svg>
          </div>
          
          <div class="relationship-details" *ngIf="selectedRelationship">
            <div class="details-header">
              <h4>{{ selectedRelationship.source }} ‚Üí {{ selectedRelationship.target }}</h4>
              <button class="close-details" (click)="selectedRelationship = null">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            
            <div class="relationship-history">
              <div class="history-content" *ngIf="selectedRelationship.history && selectedRelationship.history.length > 0">
                <div class="history-item" *ngFor="let historyItem of selectedRelationship.history; let j = index">
                  <div class="history-data" [ngSwitch]="selectedHistoryType">
                    <div *ngSwitchCase="'type'" class="history-type">
                      <strong>Type:</strong> {{ historyItem.type }}
                    </div>
                    <div *ngSwitchCase="'step'" class="history-step">
                      <strong>Step:</strong> {{ historyItem.step }}
                    </div>
                    <div *ngSwitchCase="'notes'" class="history-notes">
                      <strong>Notes:</strong> {{ historyItem.notes }}
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="no-history" *ngIf="!selectedRelationship.history || selectedRelationship.history.length === 0">
                <p>No history available for this relationship</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="characterMap.length === 0">
          <div class="empty-icon">üó∫Ô∏è</div>
          <h3>No character relationships found</h3>
          <p>Character relationships will appear here once they are mapped for this story</p>
        </div>
      </div>
    </div>
  </div>

  <div class="no-story-selected" *ngIf="!selectedStory">
    <div class="empty-icon">üìñ</div>
    <h3>No story selected</h3>
    <p>Please select a story to view character mapping</p>
  </div>
</div>

<!-- Actor Options Popup -->
<div class="actor-options-popup" [class.show]="showActorOptions">
  <div class="popup-content">
    <div class="popup-header">
      <h3>Actor Options for {{ selectedCharacter?.name }}</h3>
      <button class="close-popup" (click)="closeActorOptions()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="popup-body">
      <div class="actor-suggestions">
        <p>Actor suggestions and casting options will be implemented here.</p>
        <div class="placeholder-content">
          <div class="suggestion-item">
            <strong>Suggested Actors:</strong>
            <p>Based on character description and demographics</p>
          </div>
          <div class="suggestion-item">
            <strong>Physical Traits:</strong>
            <p>Age range, appearance, and casting requirements</p>
          </div>
          <div class="suggestion-item">
            <strong>Voice Characteristics:</strong>
            <p>Tone, accent, and vocal requirements</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>