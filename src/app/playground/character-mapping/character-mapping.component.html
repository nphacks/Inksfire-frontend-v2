<div class="character-mapping-container">
  <div class="character-mapping-header">
    <h1>Character Mapping</h1>
    <div class="story-selector">
      <label>Select Story:</label>
      <select [(ngModel)]="selectedStoryIndex" (change)="onStoryChange()">
        <option *ngFor="let story of stories; let i = index" [value]="i">
          {{ story.title }}
        </option>
      </select>
    </div>
  </div>

  <div class="character-mapping-content" *ngIf="selectedStory">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button 
        (click)="activeTab = 'characters'"
        [class.active]="activeTab === 'characters'"
        class="tab-btn">
        <mat-icon>people</mat-icon>
        Characters
      </button>
      <button 
        (click)="activeTab = 'map'"
        [class.active]="activeTab === 'map'"
        class="tab-btn">
        <mat-icon>account_tree</mat-icon>
        Map
      </button>
    </div>

    <!-- Characters Tab -->
    <div class="tab-content" *ngIf="activeTab === 'characters'">
      <div class="characters-table">
        <div class="table-header">
          <div class="header-cell character-col">Character</div>
          <div class="header-cell actors-col">Actors</div>
          <div class="header-cell notes-col">Notes</div>
          <div class="header-cell actions-col">Actions</div>
        </div>
        
        <div class="table-row" *ngFor="let character of characterList; let i = index">
          <div class="table-cell character-cell">
            <h4>{{ character.name }}</h4>
            <p>{{ character.description }}</p>
          </div>
          
          <div class="table-cell actors-cell">
            <div class="actors-list" *ngIf="character.actors && character.actors.length > 0">
              <span 
                *ngFor="let actor of character.actors" 
                class="actor-name"
                (click)="showActorInfoDrawer(actor)">
                {{ actor.name }}
              </span>
            </div>
            <div class="no-actors" *ngIf="!character.actors || character.actors.length === 0">
              No actors assigned
            </div>
          </div>
          
          <div class="table-cell notes-cell">
            <textarea 
              [(ngModel)]="character.notes" 
              (input)="saveCharacterNotes(character)"
              placeholder="Add your notes about this character..."
              rows="3"></textarea>
          </div>
          
          <div class="table-cell actions-cell">
            <button class="actor-options-btn" (click)="openActorOptions(character)">
              <mat-icon>person_search</mat-icon>
              Actor Options
            </button>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="characterList.length === 0">
          <div class="empty-icon">üë•</div>
          <h3>No characters found</h3>
          <p>Characters will appear here once they are created for this story</p>
        </div>
      </div>
    </div>

    <!-- Map Tab -->
    <div class="tab-content" *ngIf="activeTab === 'map'">
      <div class="map-content">
        <div class="map-controls" *ngIf="characterMap.length > 0">
          <div class="history-selector">
            <label>View History:</label>
            <select [(ngModel)]="selectedHistoryType" (change)="onHistoryTypeChange()">
              <option value="type">Type</option>
              <option value="step">Step</option>
              <option value="notes">Notes</option>
            </select>
          </div>
        </div>

        <div class="character-tree-map" *ngIf="characterMap.length > 0">
          <div #d3Container class="d3-tree-container"></div>
        </div>
        
        <div class="empty-state" *ngIf="characterMap.length === 0">
          <div class="empty-icon">üó∫Ô∏è</div>
          <h3>No character relationships found</h3>
          <p>Character relationships will appear here once they are mapped for this story</p>
        </div>
      </div>
    </div>
  </div>

  <div class="no-story-selected" *ngIf="!selectedStory">
    <div class="empty-icon">üìñ</div>
    <h3>No story selected</h3>
    <p>Please select a story to view character mapping</p>
  </div>
</div>

<!-- Actor Options Bottom Drawer -->
<div class="bottom-drawer" [class.open]="isActorOptionsVisible">
  <div class="drawer-content">
    <div class="drawer-header">
      <h3>Actor Options for {{ selectedCharacter?.name }}</h3>
      <button class="close-drawer" (click)="closeActorOptions()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="drawer-body">
      <div class="character-context">
        <h4>Character Context</h4>
        <div class="context-content">
          <p>{{ selectedCharacter?.description }}</p>
        </div>
      </div>
      
      <div class="search-section">
        <h4>Search for Actors</h4>
        <div class="search-input-group">
          <input 
            type="text" 
            [(ngModel)]="actorSearchQuery"
            placeholder="Enter search criteria (e.g., 'male actor 30s action movies', 'blonde actress comedy')"
            class="actor-search-input" />
          <button (click)="searchActors()" class="search-btn">
            <mat-icon>search</mat-icon>
            Search
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Actor Info Bottom Drawer -->
<div class="bottom-drawer" [class.open]="isActorInfoVisible">
  <div class="drawer-content">
    <div class="drawer-header">
      <h3>{{ selectedActor?.name }}</h3>
      <button class="close-drawer" (click)="closeActorInfo()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="drawer-body">
      <div class="actor-info-content">
        <p>Actor information will be loaded from backend when clicked.</p>
        <div class="placeholder-info">
          <div class="info-item">
            <strong>Age:</strong> {{ selectedActor?.age || 'N/A' }}
          </div>
          <div class="info-item">
            <strong>Known For:</strong> {{ selectedActor?.knownFor || 'N/A' }}
          </div>
          <div class="info-item">
            <strong>Bio:</strong> {{ selectedActor?.bio || 'Actor information will be fetched from backend' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>