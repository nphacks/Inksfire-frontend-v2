<div class="character-mapping-container">
  <div class="character-mapping-header">
    <h1>Character Mapping</h1>
    <div class="story-selector">
      <label>Select Story:</label>
      <select [(ngModel)]="selectedStoryIndex" (change)="onStoryChange()">
        <option *ngFor="let story of stories; let i = index" [value]="i">
          {{ story.title }}
        </option>
      </select>
    </div>
  </div>

  <div class="character-mapping-content" *ngIf="selectedStory">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button 
        (click)="switchTab('characters')"
        [class.active]="activeTab === 'characters'"
        class="tab-btn">
        <mat-icon>people</mat-icon>
        Characters
      </button>
      <button 
        (click)="switchTab('map')"
        [class.active]="activeTab === 'map'"
        class="tab-btn">
        <mat-icon>account_tree</mat-icon>
        Map
      </button>
      <button 
        (click)="switchTab('beats')"
        [class.active]="activeTab === 'beats'"
        class="tab-btn">
        <mat-icon>timeline</mat-icon>
        Story Beats
      </button>
    </div>

    <!-- Characters Tab -->
    <div class="tab-content" *ngIf="activeTab === 'characters'">
      <div class="characters-table">
        <div class="table-header">
          <div class="header-cell character-col">Character</div>
          <div class="header-cell actors-col">Actors</div>
          <div class="header-cell notes-col">Notes</div>
          <div class="header-cell actions-col">Actions</div>
        </div>
        
        <div class="table-row" *ngFor="let character of characterList; let i = index">
          <div class="table-cell character-cell">
            <h4>{{ character.name }}</h4>
            <p>{{ character.description }}</p>
          </div>
          
          <div class="table-cell actors-cell">
            <div class="actors-list" *ngIf="character.actors && character.actors.length > 0">
              <span 
                *ngFor="let actor of character.actors" 
                class="actor-name"
                (click)="showActorInfoDrawer(actor)">
                {{ actor.name }}
              </span>
            </div>
            <div class="no-actors" *ngIf="!character.actors || character.actors.length === 0">
              No actors assigned
            </div>
          </div>
          
          <div class="table-cell notes-cell">
            <textarea 
              [(ngModel)]="character.notes" 
              (input)="saveCharacterNotes(character)"
              placeholder="Add your notes about this character..."
              rows="3"></textarea>
          </div>
          
          <div class="table-cell actions-cell">
            <button class="actor-options-btn" (click)="openActorOptions(character)">
              <mat-icon>person_search</mat-icon>
              Actor Options
            </button>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="characterList.length === 0">
          <div class="empty-icon">üë•</div>
          <h3>No characters found</h3>
          <p>Characters will appear here once they are created for this story</p>
        </div>
      </div>
    </div>

    <!-- Story Beats Tab -->
    <div class="tab-content" *ngIf="activeTab === 'beats'">
      <div class="story-beats-content">
        <div class="beats-timeline" *ngIf="selectedStory?.story_beats && selectedStory.story_beats.length > 0; else noBeatsTemplate">
          <div class="timeline-container">
            <div class="timeline-line"></div>
            <div 
              *ngFor="let beat of selectedStory.story_beats; let i = index" 
              class="beat-item"
              [class.left]="i % 2 === 0"
              [class.right]="i % 2 === 1">
              <div class="beat-marker">
                <div class="beat-number">{{ i + 1 }}</div>
              </div>
              <div class="beat-content">
                <div class="beat-header">
                  <h4 class="beat-title">{{ beat.title || beat.name || 'Beat ' + (i + 1) }}</h4>
                  <span class="beat-type" *ngIf="beat.type">{{ beat.type }}</span>
                </div>
                <p class="beat-description">{{ beat.description || beat.content }}</p>
                <div class="beat-meta" *ngIf="beat.duration || beat.page_count">
                  <span *ngIf="beat.duration" class="meta-item">
                    <mat-icon>schedule</mat-icon>
                    {{ beat.duration }}
                  </span>
                  <span *ngIf="beat.page_count" class="meta-item">
                    <mat-icon>description</mat-icon>
                    {{ beat.page_count }} pages
                  </span>
                </div>
                <div class="beat-characters" *ngIf="beat.characters && beat.characters.length > 0">
                  <div class="characters-label">Characters:</div>
                  <div class="character-tags">
                    <span *ngFor="let character of beat.characters" class="character-tag">
                      {{ character }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <ng-template #noBeatsTemplate>
      <div class="empty-state">
        <div class="empty-icon">üé¨</div>
        <h3>No story beats found</h3>
        <p>Story beats will appear here once they are generated for this story</p>
      </div>
    </ng-template>

    <!-- Map Tab -->
    <div class="tab-content" *ngIf="activeTab === 'map'">
      <div class="map-content">
        <div class="map-controls" *ngIf="characterMap.length > 0">
          <div class="history-selector">
            <label>View History:</label>
            <select [(ngModel)]="selectedHistoryType" (change)="onHistoryTypeChange()">
              <option value="type">Type</option>
              <option value="step">Step</option>
              <option value="notes">Notes</option>
            </select>
          </div>
        </div>

        <div class="character-tree-map" *ngIf="characterMap.length > 0">
          <div #d3Container class="d3-tree-container"></div>
        </div>
        
        <div class="empty-state" *ngIf="characterMap.length === 0">
          <div class="empty-icon">üó∫Ô∏è</div>
          <h3>No character relationships found</h3>
          <p>Character relationships will appear here once they are mapped for this story</p>
        </div>
      </div>
    </div>

  <div class="no-story-selected" *ngIf="!selectedStory">
    <div class="empty-icon">üìñ</div>
    <h3>No story selected</h3>
    <p>Please select a story to view character mapping</p>
  </div>
</div>

<!-- Actor Options Bottom Drawer -->
<div class="bottom-drawer" [class.open]="isActorOptionsVisible">
  <div class="drawer-content">
    <div class="drawer-header">
      <h3>Actor Options for {{ selectedCharacter?.name }}</h3>
      <button class="close-drawer" (click)="closeActorOptions()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="drawer-body">
      <div class="character-context">
        <h4>Character Context</h4>
        <div class="context-content">
          <p>{{ selectedCharacter?.description }}</p>
        </div>
      </div>
      
      <div class="search-section">
        <h4>Search for Actors</h4>
        <div class="search-input-group">
          <input 
            type="text" 
            [(ngModel)]="actorSearchQuery"
            placeholder="Enter search criteria (e.g., 'male actor 30s action movies', 'blonde actress comedy')"
            class="actor-search-input" />
          <button (click)="searchActors()" class="search-btn">
            <mat-icon>search</mat-icon>
            Search
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Actor Info Bottom Drawer -->
<div class="bottom-drawer" [class.open]="isActorInfoVisible">
  <div class="drawer-content">
    <div class="drawer-header">
      <h3>{{ selectedActor?.name }}</h3>
      <button class="close-drawer" (click)="closeActorInfo()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="drawer-body">
      <div class="actor-info-content">
        <p>Actor information will be loaded from backend when clicked.</p>
        <div class="placeholder-info">
          <div class="info-item">
            <strong>Age:</strong> {{ selectedActor?.age || 'N/A' }}
          </div>
          <div class="info-item">
            <strong>Known For:</strong> {{ selectedActor?.knownFor || 'N/A' }}
          </div>
          <div class="info-item">
            <strong>Bio:</strong> {{ selectedActor?.bio || 'Actor information will be fetched from backend' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>